<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>★ 랜덤 디펜스 (모바일) ★</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="multiplayer.css">
</head>

<body>
    <!-- 로비 화면 -->
    <div id="lobby-screen" class="screen active">
        <div class="lobby-container">
            <h1 class="game-title">★ 랜덤 디펜스 ★</h1>


            <button class="btn btn-primary btn-large" id="single-mode-btn">🎮 싱글 모드</button>
            <button class="btn btn-primary btn-large" id="multi-mode-btn"
                style="margin-top: 10px; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);">👥 멀티
                모드</button>
            <button class="btn btn-secondary" id="open-ranking-btn" style="margin-top: 10px; width: 100%;">🏆 랭킹
                보기</button>

        </div>
    </div>

    <!-- 게임 오버 화면 -->
    <div id="gameover-screen" class="screen">
        <div class="lobby-container">
            <h1 class="game-title" style="color: #EF4444;">게임 오버</h1>

            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <span style="color: #F1F5F9; font-size: 14px;">도달 라운드</span>
                    <div style="color: #FBBF24; font-size: 32px; font-weight: bold;" id="final-round">0</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <span style="color: #F1F5F9; font-size: 14px;">처치 수</span>
                    <div style="color: #10B981; font-size: 24px; font-weight: bold;" id="final-kills">0</div>
                </div>
            </div>

            <button class="btn btn-secondary" id="register-ranking-btn"
                style="background: #fbbf24; color: black; font-weight: bold; width: 100%; margin-bottom: 10px;">🏆 랭킹
                등록</button>
            <button class="btn btn-secondary" id="lobby-btn" style="width: 100%;">로비로</button>
        </div>
    </div>

    <!-- 게임 화면 (모바일 레이아웃) -->
    <div id="game-screen" class="screen">
        <div class="mobile-game-container">
            <!-- 상단 게임 영역 -->
            <div class="game-area-mobile">
                <!-- 상단 HUD -->
                <div class="hud-mobile">
                    <div class="hud-item">
                        <span class="label">라운드</span>
                        <span class="value">
                            <span id="current-round">1</span>
                            <span id="monster-hp-display"
                                style="font-size: 0.6em; color: #EF4444; margin-left: 5px;">(HP: 200)</span>
                        </span>
                    </div>
                    <div class="hud-item">
                        <span class="label">시간</span>
                        <span class="value" id="round-timer">30</span>
                    </div>
                    <div class="hud-item">
                        <span class="label">골드</span>
                        <span class="value gold" id="game-gold">0</span>
                    </div>
                    <div class="hud-item pointer" id="speed-btn-container"
                        style="cursor: pointer; transition: transform 0.1s;">
                        <span class="label">속도</span>
                        <span class="value" id="game-speed-display">x1</span>
                    </div>
                </div>

                <!-- 게임 캔버스 -->
                <canvas id="game-canvas" width="800" height="600"></canvas>

                <!-- 하단 통계 -->
                <div class="stats-mobile">
                    <span>몬스터: <span id="monster-count">0</span>/200</span>
                    <span>|</span>
                    <span>처치: <span id="kill-count">0</span></span>
                    <span>|</span>
                    <span>DPS: <span id="dps-display">0</span></span>
                </div>
            </div>

            <!-- 패널 토글 버튼 -->
            <button class="panel-toggle-btn" id="panel-toggle-btn">
                <span class="toggle-icon">▲</span>
                <span class="toggle-text">메뉴</span>
            </button>

            <!-- 하단 컨트롤 패널 (접을 수 있음) -->
            <div class="control-panel-mobile" id="control-panel-mobile">
                <!-- 기본 뷰 (메인 메뉴) -->
                <div id="main-view" class="panel-view active">
                    <div class="panel-section">
                        <h3>메인 메뉴</h3>
                        <div class="button-grid">
                            <button class="btn-boss" id="mission-boss-btn">
                                <span>미션 보스 소환</span>
                                <span class="cooldown" id="boss-cooldown">준비</span>
                                <span class="boss-hp" id="boss-hp-display" style="font-size: 0.7em; color: #FBBF24;">HP:
                                    0</span>
                            </button>
                            <button class="btn-achievement" id="achievements-btn">
                                <span>🏆 업적</span>
                            </button>
                            <button class="btn-upgrade" id="tower-upgrade-btn">
                                <span>타워 강화</span>
                            </button>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3>타워 뽑기</h3>
                        <div class="button-grid" id="gacha-button-grid">
                            <button class="btn-gacha" id="single-pull-btn">
                                <span>1회 뽑기</span>
                                <span class="cost" id="single-pull-cost">50G</span>
                            </button>
                            <button class="btn-gacha" id="ten-pull-btn">
                                <span>10회 뽑기</span>
                                <span class="cost" id="ten-pull-cost">450G</span>
                            </button>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3>타워 특수 기능</h3>
                        <div class="button-grid">
                            <button class="btn-special" id="tower-exchange-btn">
                                <span>🔄 타워 교환</span>
                            </button>
                            <button class="btn-special" id="tower-fusion-btn">
                                <span>🔮 타워 합체</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 칸 선택 뷰 (타워 관리) -->
                <div id="cell-view" class="panel-view">
                    <button class="btn-back" id="back-to-main-btn">
                        <span>← 뒤로가기</span>
                    </button>

                    <!-- 관리자 타워 소환 (관리자 모드 전용) -->
                    <div class="panel-section" id="admin-panel" style="display: none;">
                        <h3>🔧 관리자 소환</h3>
                        <div class="admin-spawn">
                            <select id="admin-rarity-select" class="admin-select">
                                <option value="COMMON">일반</option>
                                <option value="UNCOMMON">희귀</option>
                                <option value="RARE">레어</option>
                                <option value="EPIC">에픽</option>
                                <option value="UNIQUE">유니크</option>
                                <option value="LEGENDARY">레전드</option>
                                <option value="MYTHIC">미스틱</option>
                                <option value="DIVINE">신화</option>
                                <option value="TRANSCENDENT">초월</option>
                            </select>
                            <select id="admin-tower-select" class="admin-select">
                                <option value="STANDARD">일반 타워</option>
                                <option value="SPLASH">스플래시 타워</option>
                                <option value="SNIPER">저격 타워</option>
                            </select>
                            <button class="btn-admin-spawn" id="admin-spawn-btn">
                                <span>소환</span>
                            </button>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3>선택된 칸: <span id="selected-cell-info">없음</span></h3>
                        <div class="tower-list" id="cell-tower-list">
                            <p style="text-align: center; opacity: 0.6; color: #F1F5F9;">타워 없음</p>
                        </div>
                    </div>
                </div>

                <!-- 타워 강화 뷰 -->
                <div id="upgrade-view" class="panel-view">
                    <button class="btn-back" id="back-from-upgrade-btn">
                        <span>← 뒤로가기</span>
                    </button>

                    <div class="panel-section">
                        <h3>타워 강화</h3>
                        <div class="tower-upgrade-list" id="tower-upgrade-list">
                            <!-- 동적으로 생성 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

    <div class="achievements-earned" id="achievements-earned">
        <!-- 달성한 업적 표시 -->
    </div>

    <div class="gameover-buttons">
        <button class="btn btn-secondary" id="register-ranking-btn"
            style="background: #fbbf24; color: black; font-weight: bold;">🏆 랭킹 등록</button>
        <button class="btn btn-primary" id="restart-btn">다시하기</button>
        <button class="btn btn-secondary" id="lobby-btn">로비로</button>
    </div>
    </div>
    </div>

    <!-- 모달들 -->
    <div id="upgrades-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>스탯 강화</h2>
                <button class="close-btn" data-modal="upgrades-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upgrade-list" id="upgrade-list"></div>
            </div>
        </div>
    </div>

    <div id="achievements-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>업적</h2>
                <button class="close-btn" data-modal="achievements-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="achievement-list" id="achievement-list"></div>
            </div>
        </div>
    </div>

    <div id="tower-exchange-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔄 타워 교환</h2>
                <button class="close-btn" data-modal="tower-exchange-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div
                    style="margin-bottom: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #FBBF24; border-radius: 5px;">
                    <p style="margin: 0; color: #FBBF24; font-size: 0.9em;">
                        💡 레전드 이상 타워를 다른 타입으로 교환할 수 있습니다.<br>
                        성공 확률: 70% | 실패 시 골드만 소모
                    </p>
                </div>
                <div id="exchange-tower-list" class="tower-list">
                    <!-- 동적으로 생성 -->
                </div>
            </div>
        </div>
    </div>

    <div id="tower-fusion-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔮 타워 합체</h2>
                <button class="close-btn" data-modal="tower-fusion-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div
                    style="margin-bottom: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #FBBF24; border-radius: 5px;">
                    <p style="margin: 0; color: #FBBF24; font-size: 0.9em;">
                        💡 같은 등급의 서로 다른 타입 타워 3개를 합쳐 트리니티 타워를 생성합니다.<br>
                        성공 확률: 70% | 실패 시 골드 소모 + 랜덤 1개 타워 소실
                    </p>
                </div>
                <div id="fusion-tower-list" class="tower-list">
                    <!-- 동적으로 생성 -->
                </div>
            </div>
        </div>
    </div>

    <div id="battlepass-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>배틀패스</h2>
                <button class="close-btn" data-modal="battlepass-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="battlepass-tiers" id="battlepass-tiers"></div>
            </div>
        </div>
    </div>

    <div id="gacha-result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>뽑기 결과</h2>
                <button class="close-btn" data-modal="gacha-result-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="gacha-results" id="gacha-results"></div>
            </div>
        </div>
    </div>

    <!-- 랭킹 모달 (전역) -->
    <div id="ranking-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; background: #1a1a1a; border: 1px solid #444;">
            <div class="modal-header" style="border-bottom: 1px solid #333;">
                <h2>🏆 명예의 전당</h2>
                <button class="close-btn" data-modal="ranking-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="ranking-list" style="min-height: 200px; padding: 10px;">
                    <p style="text-align:center; color:#888;">데이터 불러오는 중...</p>
                </div>

                <div id="ranking-register-form"
                    style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                    <h3 style="margin-bottom: 10px; font-size: 1.1em; color: #fbbf24;">신기록 달성!</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="ranking-username" placeholder="아이디 (최대 8자)" maxlength="8"
                            style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 4px;">
                        <input type="password" id="ranking-password" placeholder="비밀번호 (4자리)" maxlength="4"
                            style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 4px;">
                        <button onclick="submitMyScore()"
                            style="width: 100%; padding: 10px; background: #fbbf24; color: black; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                            등록
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 알림 토스트 -->
    <div id="toast-container"></div>

    <!-- 전역 에러 핸들러 (디버깅용) -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const errorMsg = `오류 발생: ${msg}\n위치: ${url}:${line}`;
            console.error(errorMsg);
        };
    </script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 환경변수 (gitignore) -->
    <script src="js/env.js"></script>

    <!-- JavaScript 파일들 -->
    <script src="js/config.js?v=final3"></script>
    <script src="js/utils.js?v=final3"></script>
    <script src="js/tower-exchange.js"></script>
    <script src="js/tower-fusion.js"></script>
    <script src="js/sound.js"></script>
    <script src="js/no-copy.js"></script>
    <script src="js/monster.js?v=final3"></script>
    <script src="js/tower.js?v=final3"></script>
    <script src="js/gacha.js?v=final3"></script>
    <script src="js/economy.js?v=final3"></script>
    <script src="js/upgrades.js?v=final3"></script>
    <script src="js/renderer.js?v=final3"></script>
    <script src="js/tower-ui.js?v=final3"></script>
    <script src="js/tower-upgrade.js?v=final3"></script>
    <script src="js/ui.js?v=final3"></script>
    <script src="js/ranking.js?v=final3"></script>
    <script src="js/game.js?v=final3"></script>
    <script src="js/panel-manager.js?v=final"></script>

    <script src="js/panel-toggle.js?v=final"></script>

    <!-- 멀티플레이 로비 화면 -->
    <div id="multiplayer-lobby-screen" class="screen">
        <div class="multiplayer-lobby-container">
            <h1 class="lobby-mode-title">👥 멀티플레이</h1>

            <div class="lobby-input-group">
                <label for="player-name-input">플레이어 이름</label>
                <input type="text" id="player-name-input" placeholder="이름을 입력하세요" maxlength="10">
            </div>

            <button class="btn btn-primary btn-large" id="create-room-btn">🏠 방 만들기</button>

            <div class="lobby-divider">또는</div>

            <div class="lobby-input-group">
                <label for="room-code-input">방 코드</label>
                <input type="text" id="room-code-input" placeholder="8자리 코드 입력" maxlength="8"
                    style="text-transform: uppercase;">
            </div>

            <button class="btn btn-primary btn-large" id="join-room-btn">🚪 방 입장</button>
            <button class="btn btn-secondary" id="back-to-lobby-btn" style="margin-top: 10px; width: 100%;">←
                로비로</button>

            <div id="connection-status" style="margin-top: 20px; text-align: center;">연결 중...</div>
        </div>
    </div>

    <!-- 대기실 화면 -->
    <div id="waiting-room-screen" class="screen">
        <div class="waiting-room-container">
            <div class="room-code-display-container">
                <div class="room-code-label">방 코드</div>
                <div class="room-code-value" id="room-code-display">--------</div>
            </div>

            <div class="player-list-container">
                <h3 class="player-list-title">참가자 목록</h3>
                <div id="waiting-room-player-list">
                    <!-- 동적으로 생성 -->
                </div>
            </div>

            <button class="btn btn-primary btn-large" id="start-multiplayer-game-btn">🎮 게임 시작</button>
            <button class="btn btn-secondary" id="leave-room-btn" style="margin-top: 10px; width: 100%;">← 나가기</button>
        </div>
    </div>

    <!-- 다른 플레이어 필드 뷰어 (게임 중) -->
    <div id="other-players-fields"></div>

    <!-- Socket.IO 클라이언트 라이브러리 -->
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <!-- 멀티플레이 스크립트 -->
    <script src="js/socket-client.js"></script>
    <script src="js/multiplayer-room.js"></script>
    <script src="js/multiplayer-game.js"></script>
    <script src="js/multiplayer-notifications.js"></script>
    <script src="js/achievements.js"></script>
</body>

</html>